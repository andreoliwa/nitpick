env:
  global:
    - CC_TEST_REPORTER_ID=2da342a92e29aa78fcf1dc84b18af77f8eede63db675363fd1151673be3ce4f3
    - PRE_COMMIT_HOME=$HOME/.cache/pre-commit
    - TWINE_USERNAME=andreoliwa
    - COVERALLS_PARALLEL=true
cache:
  npm: true
  directories:
    - $HOME/.cache/pip
    - $PRE_COMMIT_HOME
# https://docs.travis-ci.com/user/languages/python/
language: python
# https://docs.travis-ci.com/user/reference/xenial/
dist: xenial
install:
  - pip3 install --upgrade pip poetry coveralls pre-commit
  - poetry install --no-ansi --no-interaction
before_script:
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build
script:
  - "./.travis/script.sh"
after_script:
  - coverage xml
  - if [[ "$TRAVIS_PULL_REQUEST" == "false" && "$TRAVIS_PYTHON_VERSION" == "3.6" ]]; then ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT; fi
after_success:
  - coverage combine
  - coveralls
notifications:
  # https://docs.coveralls.io/parallel-build-webhook
  webhooks:
    - https://coveralls.io/webhook
stages:
  - name: release
    if: branch = master
  - name: test
jobs:
  include:
    # Define the release stage that runs semantic-release
    # https://github.com/semantic-release/semantic-release/blob/master/docs/recipes/travis.md
    - stage: release
      script: skip
      install:
        - pip install -U poetry pre-commit bumpversion twine
        - npm install -g semantic-release@15 @semantic-release/changelog @semantic-release/git @semantic-release/exec
      deploy:
        provider: script
        skip_cleanup: true
        script: semantic-release
    - stage: test
      name: "Python 3.7 Linux"
      python: 3.7
    - name: "Python 3.6 Linux"
      python: 3.6
    - name: "Python 3.5 Linux"
      python: 3.5
    # Thanks to https://github.com/cclauss/Travis-CI-Python-on-three-OSes/blob/master/.travis.yml
    - name: "Python 3.7 Windows"
      os: windows
      language: shell
      before_install:
        - choco install python3 --version=3.7.4
        - refreshenv
        - python -m pip install --upgrade pip
      env: PATH=/c/Python37:/c/Python37/Scripts:$PATH
